<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeFQUIN - Interacting with a HeFQUIN Service</title>

    <!-- Prism -->
    <link href="../css/prism-tomorrow.css" rel="stylesheet">
    <link href="../css/prism-toolbar.min.css" rel="stylesheet">
    <script src="../js/prism_1.29.0/prism.min.js"></script>
    <script src="../js/prism_1.29.0/prism-json.min.js"></script>
    <script src="../js/prism_1.29.0/prism-bash.min.js"></script>
    <script src="../js/prism_1.29.0/prism-toolbar.min.js"></script>
    <script src="../js/prism_1.29.0/prism-copy-to-clipboard.min.js"></script>

    <script src="../js/mustache.min.js"></script>
    <script src="../js/script.js"></script>
    <link rel="stylesheet" href="../css/style.css">

    <script>
        // trim any preceeding or trailing whitespaces from code snippets
        window.addEventListener('load', trimCode);
    </script>
</head>

<body>
    <div id="header"></div>

    <main>
        <h1>Interacting with a HeFQUIN Service</h1>
        <p>
            After starting a HeFQUIN service (which you can do either <a href="docker.html">using Docker</a>, <a
                href="embedded_servlet_container.html">using a servlet container embedded in HeFQUIN</a>, or <a
                href="separate_servlet_container.html">using your own, separate servlet container</a>), you can first
            test it by opening <code><a href="http://localhost:8080/">http://localhost:8080/</a></code> in a Web browser
            (assuming that you have started the service at port 8080). If this works (i.e., you see a page that
            describes the service), you can start interacting with the service via HTTP. In particular,
        </p>
        <ul>
            <li>you can <a href="#issuing-queries">issue queries</a> and</li>
            <li>you can <a href="inspecting-queries">issue a request for query processing details</a>.</li>
        </ul>
        <p>
            While the following sections describe these options in detail, we also provide an <a href="hefquin_api.html">OpenAPI documentation of the API of the HeFQUIN service</a>. This documentation is also available at the root endpoint of the service:
            <code><a href="http://localhost:8080/">http://localhost:8080/</a></code> (assuming that you have started the service at port 8080).
        </p>

        <section id="issuing-queries">
            <h2>Issuing Queries</h2>
            <p>
                At the address <a  href="http://localhost:8080/query">http://localhost:8080/query</a> the HeFQUIN service provides a <a href="https://www.w3.org/TR/sparql11-protocol/">SPARQL endpoint</a> via which clients can issue <a href="queries.html">SPARQL queries to be executed over the federation</a> for which the service has been set up. To this end, the client may send a GET request or a POST request.
            </p>
            <p>
                In the case of a <b>GET request</b>, the query needs to be provided in URL-encoded form via the URL parameter <code>query</code> (the URL parameters <code>default-graph-uri</code> and <code>named-graph-uri</code>, as introduced for <a href="https://www.w3.org/TR/sparql11-protocol/">SPARQL endpoints</a>, are not supported by the HeFQUIN service).
            </p>
            <p>
                In a <b>POST request</b>, the (unencoded) query may be provided directly in the request body, in which
                case the request header must contain a <code>Content-Type</code> field with
                <code>application/sparql-query</code> as value. Alternatively, the request body of the POST request may
                contain the <code>query</code> parameter with the URL-encoded query as value, in which case the value of
                the <code>Content-Type</code> field in the request header must be
                <code>application/x-www-form-urlencoded</code> (also for POST requests, the URL parameters
                <code>default-graph-uri</code> and <code>named-graph-uri</code> are not supported by HeFQUIN).
            </p>
            <p>
                For instance, by using the command-line tool <a href="https://curl.se/">curl</a>, you may execute the
                following command to issue the query in a file called <code>ExampleQuery.rq</code>.
            </p>
            <pre><code class="language-bash">
curl -X POST http://localhost:8080/sparql \
    --data-binary @ExampleQuery.rq \
    -H 'Content-Type: application/sparql-query'
            </code></pre>
            <p>
                In any case (using GET requests or POST requests), the client may <b>specify the format</b> in which it
                wants to receive the query result in the response. To this end, the client may include an
                <code>Accept</code> field in the request header, using any of the following media types (with the first
                being used as the default).
            </p>
            <ul>
                <li><a href="https://www.w3.org/TR/sparql11-results-json/">
                        <code>application/sparql-results+json</code></a> (used as the default)
                </li>
                <li><a href="https://www.w3.org/TR/rdf-sparql-XMLres/"><code>application/sparql-results+xml</code></a>
                </li>
                <li><a href="https://www.w3.org/TR/sparql11-results-csv-tsv/"><code>text/csv</code></a></li>
                <li><a href="https://www.w3.org/TR/sparql11-results-csv-tsv/"><code>text/tab-separated-values</code></a>
                </li>
            </ul>
            <p>
                Responses returned by the HeFQUIN service may use any of the following HTTP status codes.
            </p>
            <ul>
                <li><code>200 OK</code> - Returned if the query has been executed successfully. In this case, the
                    response body contains the query result, represented using the specified media type.</li>
                <li><code>400 Bad Request</code> - Returned if no query was provided in the request or the query was
                    empty or invalid.</li>
                <li><code>406 Not Acceptable</code> - Returned if the given <code>Accept</code> value is not supported.
                </li>
                <li><code>415 Unsupported Media Type</code> - Returned if the given <code>Content-Type</code> value is
                    not supported.</li>
                <li><code>500 Internal Server Error</code> - Returned if an error occurs during query execution.</li>
                <li><code>501 Not Implemented</code> - Returned if the given query uses a feature that is not supported by HeFQUIN.</li>
            </ul>
        </section>


        <section id="inspecting-queries">
            <h2>Inspecting Query Processing Details</h2>
            <p>
                The HeFQUIN service also provides a diagnostic endpoint at <a  href="http://localhost:8080/query-inspect">http://localhost:8080/query-inspect</a>, which can be used to inspect internal processing details of a given query, including the logical and physical query plans, execution times, and other statistics. This functionality is intended for debugging, performance tuning, and query analysis.
            </p>
            <p>
                The endpoint <code>/query-inspect</code> supports both GET and POST requests using the same content
                types and parameters as the <code>/sparql</code> endpoint.
            </p>
            <p>
                For instance, by using the command-line tool <a href="https://curl.se/">curl</a>, you may execute the following command to issue the query in a file called <code>ExampleQuery.rq</code> and retrieve information about the resulting query execution process.
            </p>
            <pre><code class="language-bash">
curl -X POST http://localhost:8080/query-inspect \
    --data-binary @ExampleQuery.rq \
    -H 'Content-Type: application/sparql-query'
            </code></pre>
            <p>
                The service will return a response in JSON format, with <code>application/json</code> as the content type.
            </p>
            <p>
                Responses returned by the service may use any of the following HTTP status codes.
            </p>
            <ul>
                <li><code>200 OK</code> - Returned if the query has been executed successfully. In this case, the
                    response body contains the query processing details as a JSON object (see below).</li>
                <li><code>400 Bad Request</code> - Returned if no query was provided in the request or the query was
                    empty or invalid.</li>
                <li><code>406 Not Acceptable</code> - Returned if the given <code>Accept</code> value is not supported.
                </li>
                <li><code>415 Unsupported Media Type</code> - Returned if the given <code>Content-Type</code> value is
                    not supported.</li>
                <li><code>500 Internal Server Error</code> - Returned if an error occurs during query execution.</li>
                <li><code>501 Not Implemented</code> - Returned if the given query uses a feature that is not supported by HeFQUIN.</li>
            </ul>
            <p>
                If the request is valid, the response will include:
            </p>
            <ul>
                <li>the source assignment that was passed to the logical optimizer,</li>
                <li>the logical plan that was passed to the physical optimizer,</li>
                <li>the physical plan that was selected for execution,</li>
                <li>timing metrics (overall, planning, compilation, execution),</li>
                <li>detailed statistics of the query planner and of the execution process, and</li>
                <li>any exceptions collected during the execution process.</li>
            </ul>
            <p>
                Below follows an example of the structure of the output that can be expected.
            </p>
            <pre><code class="language-json">
{
    "queryMetrics": {
        "overallQueryProcessingTime": 222,
        "planningTime": 3,
        "compilationTime": 1,
        "executionTime": 200,
        "queryPlanningStats": { ... },
    	"executionStats": { ... },
        "physicalPlan": "(physical plan representation)",
        "logicalPlan": "(logical plan representation)",
        "sourceAssignment": "(source assignment)",
        "exceptions": [ ]
    }
}
            </code></pre>
        </section>
    </main>

    <div id="footer"></div>
</body>

</html>
